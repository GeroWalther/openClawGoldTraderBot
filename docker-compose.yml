services:
  ib-gateway:
    image: ghcr.io/gnzsnz/ib-gateway:latest
    container_name: ib-gateway
    restart: unless-stopped
    environment:
      TWS_USERID: ${IBKR_USERNAME}
      TWS_PASSWORD: ${IBKR_PASSWORD}
      TRADING_MODE: paper  # Change to "live" when ready
      TWS_SETTINGS_PATH: /home/ibgateway/Jts
      TWOFA_TIMEOUT_ACTION: restart
      RELOGIN_AFTER_TWOFA_TIMEOUT: "yes"
      AUTO_RESTART_TIME: "11:59 PM"
    ports:
      - "127.0.0.1:4001:4001"  # Live trading
      - "127.0.0.1:4002:4002"  # Paper trading
      - "127.0.0.1:5900:5900"  # VNC (optional, for debugging)
    volumes:
      - ib-gateway-data:/home/ibgateway/Jts
    healthcheck:
      test: ["CMD", "nc", "-z", "localhost", "4002"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  gold-trader:
    build: .
    container_name: gold-trader
    restart: unless-stopped
    depends_on:
      ib-gateway:
        condition: service_healthy
    ports:
      - "127.0.0.1:8001:8001"
    environment:
      IBKR_HOST: ib-gateway
      IBKR_PORT: 4002  # Paper trading port
      IBKR_CLIENT_ID: 1
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID}
      API_SECRET_KEY: ${API_SECRET_KEY}
      DATABASE_URL: sqlite+aiosqlite:////data/trades.db
      LOG_LEVEL: INFO
    volumes:
      - trade-data:/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s

volumes:
  ib-gateway-data:
  trade-data:
